version: '2'

vars:
  registry: docker-registry.dun.fh
  service_name: zkui-custom

include:
  - from: git+ssh://git@github.com:findmypast/usher_shared_tasks.git
    name: shared_tasks as global
    import:
      - deploy_k8s

tasks:
  build:
    description: Build the docker image. You must pass "tag" to provide the image tag for this build.
    do: shell
    command: docker build --force-rm -t <%=registry%>/findmypast/<%=service_name%>:<%=tag%> .

  push:
    description: Push the docker image to the FMP docker repository. You must pass "tag" to provide the image tag for this image.
    do: shell
    command: docker push <%=registry%>/findmypast/<%=service_name%>:<%=tag%>

  pull:
    description: Pull the docker image from the FMP docker repository. You must pass "tag" to provide the image tag for this image.
    do: shell
    command: docker pull <%=registry%>/findmypast/<%=service_name%>:<%=tag%>

  deploy:
    description: Deploy ZKUI
    do: global.deploy_k8s.deploy
    environment: integration
    helm_overrides:
      image.tag: <%=tag%>
